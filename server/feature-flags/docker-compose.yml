# UnaMentis Feature Flag System
# Powered by Unleash - Open Source Feature Management
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose logs -f        # View logs
#   docker compose down           # Stop all services
#   docker compose down -v        # Stop and remove volumes (data loss!)
#
# Access:
#   Unleash UI: http://localhost:4242 (admin/unleash4all)
#   Unleash API: http://localhost:4242/api
#   Proxy (for clients): http://localhost:3063/proxy

services:
  # PostgreSQL database for Unleash
  postgres:
    image: postgres:15-alpine
    container_name: unleash-postgres
    environment:
      POSTGRES_USER: unleash
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-unleash_secret_password}
      POSTGRES_DB: unleash
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unleash"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - unleash-network

  # Unleash Server
  unleash:
    image: unleashorg/unleash-server:latest
    container_name: unleash-server
    environment:
      # Database configuration
      DATABASE_URL: postgres://unleash:${POSTGRES_PASSWORD:-unleash_secret_password}@postgres:5432/unleash
      DATABASE_SSL: "false"

      # Authentication
      INIT_ADMIN_API_TOKENS: "*:*.unleash-insecure-admin-api-token"
      INIT_CLIENT_API_TOKENS: "default:development.unleash-insecure-client-token"
      INIT_FRONTEND_API_TOKENS: "default:development.unleash-insecure-frontend-token"

      # Server configuration
      LOG_LEVEL: info
      UNLEASH_URL: http://localhost:4242

      # Feature settings
      CHECK_VERSION: "true"
      ENABLE_OAS: "true"
    ports:
      - "4242:4242"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4242/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - unleash-network

  # Unleash Edge Proxy (for client-side SDKs)
  # Provides caching and reduced load on main server
  unleash-proxy:
    image: unleashorg/unleash-proxy:latest
    container_name: unleash-proxy
    environment:
      # Connection to Unleash server
      UNLEASH_URL: http://unleash:4242/api
      UNLEASH_API_TOKEN: "*:*.unleash-insecure-admin-api-token"

      # Proxy configuration
      UNLEASH_PROXY_CLIENT_KEYS: "proxy-client-key"
      UNLEASH_PROXY_SECRETS: "proxy-secret"

      # Refresh intervals
      UNLEASH_FETCH_INTERVAL_MS: 5000

      # Server settings
      PORT: 3063
      LOG_LEVEL: info
    ports:
      - "3063:3063"
    depends_on:
      unleash:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3063/proxy/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - unleash-network

volumes:
  postgres_data:
    name: unleash-postgres-data

networks:
  unleash-network:
    name: unleash-network
    driver: bridge
